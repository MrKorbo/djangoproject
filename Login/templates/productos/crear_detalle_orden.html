{% extends 'base.html' %}
{% block titulo %} Crear Detalle de Orden {% endblock %}
{% block body %}
<form action="">
    {% csrf_token %}
    {{ form.as_p }}
    <div class="card">
        <div class="card-header">
            <h1>Tabla de Datos</h1>
        </div>
        <div class="card-body">
            <button type="button" id="agregarFila" class="display btn btn-primary">Agregar Fila</button>    <!-- Botón para agregar una fila -->
            <!-- Botón para guardar datos en la base de datos -->
            <input type="submit" class="btn btn-success" value="Guardar">
        </div>
    </div><br>

    <table id="miTabla" class="table table-striped"> <!-- Tabla DataTables -->
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Orden</th>
                <th>Accion</th>
            </tr>
        </thead>
        <tbody>
            <td><input type="text" class="form-control" name="producto" placeholder="Seleccione Producto"></td>
            <td><input type="number" class="form-control" name="cantidad" placeholder="Cantidad"></td>
            <td><input type="text" class="form-control" name="orden" placeholder="Seleccione Orden"></td>
            <td><button class="eliminarFila btn btn-danger">Eliminar</button></td>            
        </tbody>
    </table>

    <!-- Campo oculto para guardar el número de filas -->
    <input type="hidden" id="numeroFilas" name="numero_filas" value="0"><br>
    
    <script>
        $(document).ready(function() {
            var table = $('#miTabla').DataTable({
                "paging": false,
                "searching": false
            });

            // Agregar una fila al hacer clic en el botón "Agregar Fila"
            $('#agregarFila').on('click', function() {
                table.row.add([
                '<input type="text" class="form-control" name="producto" placeholder="Seleccione Producto">', 
                '<input type="number" class="form-control" name="cantidad" placeholder="Cantidad">',
                '<input type="text" class="form-control" name="orden" placeholder="Seleccione Orden">', 
                '<button class="eliminarFila btn btn-danger">Eliminar</button>'])
                .draw();
            });

            // Eliminar una fila al hacer clic en el botón "Eliminar"
            $('#miTabla tbody').on('click', '.eliminarFila', function() {
                table.row($(this).parents('tr')).remove().draw();
            });

            // Manejar el envío del formulario para guardar datos
            $('#miFormulario').on('submit', function(event) {
                event.preventDefault(); // Evitar el envío predeterminado del formulario

                // Obtener todas las filas de la tabla
                var filas = table.rows().data().toArray();

                // Actualizar el valor del campo oculto con el número de filas
                $('#numeroFilas').val(filas.length);

                // Enviar los datos del formulario al servidor
                $.ajax({
                    url: $('/guardar_datos/').attr('action'),
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        // Procesar la respuesta del servidor si es necesario
                    },
                    error: function() {
                        // Manejar errores si es necesario
                    }
                });
            });
        });
    </script>
</form>

{% endblock %}
